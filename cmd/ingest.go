package cmd

import (
	"fmt"
	"log"

	"nvdbase/database"
)

const (
	OVS_COMMIT_SEARCH_URL = "https://api.osv.dev/v1/query"
	OVS_ID_SERCH_URL      = "https://api.osv.dev/v1/vulns/"
	MODEL_NAME            = "llama3-8b-8192"
)

func Ingest(dataPath, outputFilePath, groqApiKey string) {
	data2023File := fmt.Sprintf("%s/nvdcve-1.1-2023.json", dataPath)
	data2024File := fmt.Sprintf("%s/nvdcve-1.1-2024.json", dataPath)
	vulnerabilities := database.LoadData(
		data2023File,
		data2024File,
	)

	if len(vulnerabilities) == 0 {
		log.Println("Nothing to do, exiting")
		return
	}

	pkgInfoCh := database.GetPkgInfo(vulnerabilities, groqApiKey, MODEL_NAME)
	for pkgInfo := range pkgInfoCh {
		database.VerifyAndWrite(&pkgInfo, outputFilePath)
	}
}
